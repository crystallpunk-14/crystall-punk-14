using Content.Shared._CP14.Workbench;
using Content.Shared._CP14.Workbench.Prototypes;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client._CP14.Workbench;

[GenerateTypedNameReferences]
public sealed partial class CP14WorkbenchWindow : DefaultWindow
{
    [Dependency] private readonly IEntityManager _entity = default!;
    [Dependency] private readonly IPrototypeManager _prototype = default!;

    public event Action<CP14WorkbenchUiRecipesEntry>? OnCraft;

    private readonly SpriteSystem _sprite;

    private CP14WorkbenchUiRecipesEntry _selectedEntry;

    public CP14WorkbenchWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _sprite = _entity.System<SpriteSystem>();

        CraftButton.OnPressed += _ => OnCraft?.Invoke(_selectedEntry);
    }

    public void UpdateRecipes(CP14WorkbenchUiRecipesState recipesState)
    {
        CraftsContainer.RemoveAllChildren();

        foreach (var entry in recipesState.Recipes)
        {
            var control = new CP14WorkbenchRequirementControl(entry);
            control.OnSelect += RecipeSelect;

            CraftsContainer.AddChild(control);
        }
    }

    private void RecipeSelect(CP14WorkbenchUiRecipesEntry entry, CP14WorkbenchRecipePrototype recipe)
    {
        _selectedEntry = entry;

        var result = _prototype.Index(recipe.Result);

        ItemView.Texture = _sprite.GetPrototypeIcon(recipe.Result).Default;
        ItemName.Text = Loc.GetString(result.Name);
        ItemDescription.Text = Loc.GetString(result.Description);

        ItemRequirements.RemoveAllChildren();
        foreach (var (entProtoId, count) in recipe.Entities)
        {
            ItemRequirements.AddChild(new CP14WorkbenchRecipeControl(_prototype.Index(entProtoId), count));
        }

        foreach (var (entProtoId, count) in recipe.Stacks)
        {
            ItemRequirements.AddChild(new CP14WorkbenchRecipeControl(_prototype.Index(entProtoId), count));
        }

        CraftButton.Disabled = !entry.Craftable;
    }
}
